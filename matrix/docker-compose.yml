version: '3.8'

services:
  synapse:
    image: matrixsynapse:latest
    container_name: cgraph-matrix
    ports:
      - "8008:8008"
      - "8448:8448"
    volumes:
      - ./config:/data
      - ./data:/data/uploads
    environment:
      SYNAPSE_SERVER_NAME: cgraph.org
      SYNAPSE_REPORT_STATS: "yes"
      PSYCOPG2_CONN_MAX: 25
      PYTHONUNBUFFERED: 1
    networks:
      - cgraph
    depends_on:
      - synapse-db
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8008/_matrix/client/versions"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  synapse-db:
    image: postgres:15-alpine
    container_name: cgraph-matrix-db
    environment:
      POSTGRES_USER: synapse
      POSTGRES_PASSWORD: ${SYNAPSE_DB_PASSWORD:-synapsepwd123!}
      POSTGRES_DB: synapse
      POSTGRES_INITDB_ARGS: "-c max_connections=100 -c shared_buffers=128MB"
    volumes:
      - ./data/db:/var/lib/postgresql/data
    networks:
      - cgraph
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U synapse"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

networks:
  cgraph:
    driver: bridge
