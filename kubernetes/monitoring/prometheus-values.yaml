prometheus:
  prometheusSpec:
    retention: 30d
    storageSpec:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 100Gi
    
    externalLabels:
      cluster: "cgraph-prod"
      region: "us-east-1"
    
    scrapeInterval: 15s
    evaluationInterval: 15s
    
    additionalScrapeConfigs:
      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
      
      - job_name: 'application'
        static_configs:
          - targets: ['cgraph-backend:8001']
        metrics_path: '/metrics'

alertmanager:
  enabled: true
  alertmanagerSpec:
    storage:
      volumeClaimTemplate:
        spec:
          resources:
            requests:
              storage: 10Gi
    
    config:
      global:
        slack_api_url: ${{ secrets.SLACK_WEBHOOK }}
      
      route:
        group_by: ['alertname', 'cluster', 'service']
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 12h
        receiver: 'default'
        
        routes:
          - match:
              severity: critical
            receiver: 'pagerduty'
            group_wait: 0s
            repeat_interval: 1h
          
          - match:
              severity: warning
            receiver: 'slack'
            repeat_interval: 4h
      
      receivers:
        - name: 'default'
          slack_configs:
            - channel: '#alerts'
              title: 'Alert: {{ .GroupLabels.alertname }}'
        
        - name: 'pagerduty'
          pagerduty_configs:
            - service_key: ${{ secrets.PAGERDUTY_KEY }}
        
        - name: 'slack'
          slack_configs:
            - channel: '#warnings'

grafana:
  enabled: true
  adminPassword: ${{ secrets.GRAFANA_PASSWORD }}
  
  datasources:
    - name: Prometheus
      type: prometheus
      url: http://prometheus:9090
      isDefault: true
    
    - name: Loki
      type: loki
      url: http://loki:3100
    
    - name: PostgreSQL
      type: postgres
      url: postgresql://cgraph:password@postgres:5432/cgraph
  
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: 'default'
          orgId: 1
          folder: ''
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards

loki:
  enabled: true
  persistence:
    enabled: true
    size: 50Gi